import csv
import os
import requests
import re

def podatki_o_najstarejsih_prebivalcih_po_drzavah():
    url = 'https://en.wikipedia.org/wiki/List_of_the_oldest_people_by_country'
    prevzem = requests.gete(url)
    page_content = prevzem.text

    abs_path = os.path.dirname(os.path.abspath(__file__))
    path = os.path.join(abs_path, "podatki", "nastarejsi_prebivalci_po_drzavah.html")
    with open(path, 'w', encoding='utf-8') as file1:
        file1.write(page_content)

    # Sedaj moramo iz kode izlusciti le prvo tabelo na tej spletni strani. To bomo naredili z regularnimi izrazi.   
 
    vzorec = r'<h2 id="Oldest_ever">Oldest ever</h2>([\s\S]*?)<h3 id="Territorial_and_overseas_regions_recordholders">Territorial and overseas regions recordholders</h3>'
    path = os.path.join(abs_path, "podatki", "nastarejsi_prebivalci_po_drzavah_zozani_obseg.html")
    match = re.search(vzorec, page_content)
    novi_page_content = match.group(1)
    vzorec_tabele = r'<table class="wikitable sortable">([\s\S]*?)</table>'
    match_tabele = re.search(vzorec_tabele, novi_page_content)
    novi_page_content_tabele = match_tabele.group(1)
    with open(path, 'w', encoding='utf-8') as file2:
        file2.write(novi_page_content_tabele)

    # Sestavimo novi vzorec, ki bo zajel iz vsake vrstice doloƒçene podatke.

    seznam_slovarjev = []
    vrstice = re.findall(r'<tr>.*?</tr>', novi_page_content_tabele, flags=re.DOTALL)
    drzava = None
    for vrstica in vrstice:
        if "Flag" in vrstica:
            drzava = re.search(r'Flag_of_(\w+).svg.png"', vrstica)
        spol = re.search(r'<div class="center">(.)</div></td>"', vrstica)
        matches = re.findall(r'<td class="nowrap">(.*?)</td>', vrstica)
        datum_rojstva = matches[0]
        datum_smrti = matches[1]
        leta = re.search(r'</span>(.*?)&nbsp;years', vrstica)
        dnevi = re.search(r'years, (.*?)&nbsp;days', vrstica)
        seznam_slovarjev.append({'drzava': drzava.group(1), 'spol': spol.group(1), 'datum rojstva': datum_rojstva.group(1), 'datum smrti': datum_smrti.group(1), 'starost (leta)': leta.group(1), 'starost (dnevi)': dnevi.group(1)})
        

    # Funkcija nazadnje podatke iz seznama slovarjev pretvori v csv datoteko.

    path = os.path.join(abs_path, "podatki", "nastarejsi_prebivalci_po_drzavah.csv")     
    assert seznam_slovarjev and (all(j.keys() == seznam_slovarjev[0].keys() for j in seznam_slovarjev))
    fieldnames = list(seznam_slovarjev[0].keys())

    with open(path, 'w', encoding='utf-8', newline='') as csv_file:
        writer = csv.DictWriter(csv_file, fieldnames=fieldnames)
        writer.writeheader()
        for slovar in seznam_slovarjev:
            writer.writerow(slovar)
    